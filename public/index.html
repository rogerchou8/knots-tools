<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <title>èŠ‚ç‚¹å·¥å…·åˆé›†</title>
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      height: 100vh;
    }

    nav {
      width: 200px;
      background: #f8f8f8;
      border-right: 1px solid #ddd;
      padding: 1em;
    }

    nav h2 {
      font-size: 1.2em;
      margin-bottom: 1em;
    }

    nav ul {
      list-style: none;
      padding: 0;
    }

    nav li {
      margin: 0.5em 0;
      cursor: pointer;
      color: #0077cc;
    }

    nav li:hover {
      text-decoration: underline;
    }

    main {
      flex: 1;
      padding: 2em;
      overflow-y: auto;
    }

    section {
      display: none;
    }

    section.active {
      display: block;
    }

    textarea {
      width: 100%;
      margin: 0.5em 0;
      height: 200px;
    }

    input {
      width: 100%;
      margin: 0.5em 0;
    }

    button {
      margin: 0.5em 0;
      padding: 0.5em 1em;
      cursor: pointer;
    }

    pre {
      background: #f0f0f0;
      padding: 1em;
      white-space: pre-wrap;
      word-break: break-all;
      overflow-x: auto;
      overflow-y: auto;
      max-height: 300px;
      border: 1px solid #ccc;
      margin-bottom: 0.5em;
    }

    #github-link {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background-color: #f0f0f0;
      padding: 8px 12px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      color: #0366d6;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      transition: background-color 0.2s ease;
    }

    #github-link:hover {
      background-color: #e0e0e0;
    }
  </style>
</head>

<body>
  <nav>
    <h2>ğŸŒ å·¥å…·èœå•</h2>
    <ul>
      <li onclick="switchTab('gen')">1ï¸âƒ£ èŠ‚ç‚¹ç”Ÿæˆ</li>
      <li onclick="switchTab('fofa')">2ï¸âƒ£ FOFA IP æå–</li>
      <li onclick="switchTab('extract')">3ï¸âƒ£ èŠ‚ç‚¹æå– IP</li>
      <li onclick="switchTab('fofaIpLoc')">4ï¸âƒ£ IP å®šä½å·¥å…·</li>
    </ul>
    <a href="https://github.com/rogerchou8/knots-tools" target="_blank" id="github-link">ğŸ”— Githubä»“åº“</a>
  </nav>
  <main>
    <section id="gen" class="active">
      <h3>1ï¸âƒ£ vlessèŠ‚ç‚¹ç”Ÿæˆ</h3>
      <input id="tpl" placeholder="vless://id@1.1.1.1:443?...">
      <textarea id="ips" placeholder="æ¯è¡Œä¸€ä¸ª IP åœ°å€"></textarea>
      <button onclick="genKnots()">ç”ŸæˆèŠ‚ç‚¹</button>
      <pre id="out1"></pre>
      <button onclick="copyToClipboard('out1')">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    </section>

    <section id="fofa">
      <h3>2ï¸âƒ£ æå– FOFA IP</h3>
      <textarea id="fofaIP" placeholder="ç²˜è´´ FOFA JSON å“åº”"></textarea>
      <button onclick="parseFofa()">æå– IP</button>
      <pre id="out2"></pre>
      <button onclick="copyToClipboard('out2')">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    </section>

    <section id="extract">
      <h3>3ï¸âƒ£ ä»vlessèŠ‚ç‚¹ä¸­æå– IP</h3>
      <textarea id="knots" placeholder="ç²˜è´´å¤šä¸ªèŠ‚ç‚¹"></textarea>
      <button onclick="extractIP()">æå–</button>
      <pre id="out3"></pre>
      <button onclick="copyToClipboard('out3')">ğŸ“‹ å¤åˆ¶ç»“æœ</button>
    </section>

    <section id="fofaIpLoc">
      <h3>4ï¸âƒ£ IP å®šä½å·¥å…·</h3>
      <textarea id="fofaInput" placeholder="æ¯è¡Œä¸€ä¸ª IP åœ°å€"></textarea>
      <!-- <button onclick="extractIPs()">æå– IP</button> -->
      <button onclick="lookupViaAPI()">ğŸŒ IP å®šä½</button>
      <!-- å¼•å…¥å¤–éƒ¨ JS -->
      <script src="fofa-tool.js"></script>
      <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
      <!-- å›½å®¶ç­›é€‰ -->
      <label for="countryFilter">ç­›é€‰ï¼š</label>
      <select id="countryFilter">
        <option value="">ğŸŒ å…¨éƒ¨</option>
      </select>

      <button onclick="downloadExcel()">ğŸ“¥ ä¸‹è½½ Excel</button>
      <pre id="out4"></pre>
      <pre id="out4-ip" hidden></pre>
      <button onclick="copyToClipboard('out4-ip')">ğŸ“‹ å¤åˆ¶ IP</button>
    </section>
  </main>

  <script>
    function switchTab(id) {
      document.querySelectorAll("main section").forEach(s => s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    async function genKnots() {
      const tpl = document.getElementById('tpl').value;
      const ips = document.getElementById('ips').value;
      const res = await fetch(`/knots?basicKnot=${encodeURIComponent(tpl)}`, {
        method: "POST", body: ips
      });
      document.getElementById('out1').textContent = await res.text();
    }

    async function parseFofa() {
      let raw = document.getElementById('fofaIP').value;

      // æ¸…é™¤ UTF-8 BOM å’Œå¤šä½™ç©ºæ ¼
      raw = raw.trim().replace(/^\uFEFF/, '');

      let json;
      try {
        json = JSON.parse(raw);
      } catch (e) {
        alert("âš ï¸ è¯·è¾“å…¥æ­£ç¡®çš„ JSON");
        return;
      }

      const res = await fetch('/fofa-ip', {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(json)
      });

      document.getElementById('out2').textContent = await res.text();
    }


    async function extractIP() {
      const nodes = document.getElementById('knots').value;
      const res = await fetch('/knots2IP', { method: "POST", body: nodes });
      document.getElementById('out3').textContent = await res.text();
    }

    function copyToClipboard(preId) {
      const text = document.getElementById(preId).textContent.trim();

      if (!text) {
        // å¦‚æœå†…å®¹ä¸ºç©ºæˆ–ä»…åŒ…å«ç©ºç™½å­—ç¬¦ï¼Œä¸è¿›è¡Œå¤åˆ¶
        displayCopyStatus(preId, "âŒ å†…å®¹ä¸ºç©ºï¼Œå¤åˆ¶å¤±è´¥");
        return;
      }

      navigator.clipboard.writeText(text).then(() => {
        displayCopyStatus(preId, "âœ… å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
      }).catch(err => {
        displayCopyStatus(preId, "âŒ å¤åˆ¶å¤±è´¥ï¼š" + err);
      });
    }

    function displayCopyStatus(preId, message) {
      const preElement = document.getElementById(preId);
      const statusElement = document.createElement('span');
      statusElement.textContent = message;
      statusElement.style.color = message.startsWith("âœ…") ? "green" : "red";
      statusElement.style.marginLeft = "10px";
      preElement.parentNode.appendChild(statusElement);

      // æ¸…é™¤æç¤ºä¿¡æ¯ï¼Œ1.5ç§’å
      setTimeout(() => {
        statusElement.remove();
      }, 1500);
    }

    async function lookupViaAPI() {
      const input = document.getElementById("fofaInput").value;
      const res = await fetch('/ip-lookup', {
        method: "POST",
        body: input
      });

      const data = await res.json();
      document.getElementById("out4").textContent = data.map(d => d.info).join("\n");
      document.getElementById("out4-ip").textContent = data.map(d => d.ip).join("\n");

      locationResults = data;  // ä¿å­˜æ‰€æœ‰ç»“æœ
      updateCountryFilterOptions();  // é‡å»ºå›½å®¶é€‰é¡¹
      applyCountryFilter();          // æ˜¾ç¤ºç­›é€‰ç»“æœ
    }

  </script>
</body>

</html>